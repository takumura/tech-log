{"title":"node_modulesを更新する","date":"2020-02-09","category":"Nodejs","tag":["npm","Dependabot"],"body":"\r\n\r\nGithubで管理している Node.jsアプリケーションで、依存packageのバージョンにセキュリティリスクがある場合に、Dependabotが警告してくれました。この警告を解消する手順を確認します。\r\n\r\n## 警告の内容を確認\r\n\r\ntech-logのリポジトリで、2020-02-09 時点で9件のSecurity Alertsがレポートされていました。\r\n\r\n<img src=\"assets/images/update-node-modules/update-node-modules-1.png\" alt=\"security alerts\" title=\"security alerts\">\r\n\r\nいずれもpackage.lock.jsonに対しての変更が提案されており、間接的に依存している参照の更新が必要です。\r\n\r\n## npm auditを確認\r\n\r\nnpmにも監査のコマンドがあったことを思い出し、状況を確認してみました。\r\n\r\n```ps\r\n> npm audit\r\n...\r\nfound 625 vulnerabilities (2 low, 7 moderate, 615 high, 1 critical) in 42979 scanned packages\r\n  run `npm audit fix` to fix 624 of them.\r\n  1 vulnerability requires semver-major dependency updates.\r\n```\r\n\r\n625件。。。今後の課題にしようと思います。\r\n\r\n## 個々のPRをnpm ciして確認\r\n\r\n`npm ci`コマンドにより、pacakge.lock.json を元にnode_modulesを再構築してくれるようでした。なので「個々のPRに対してローカルリポジトリ上で`npm ci`し、appの挙動に問題がなければmasterへmergeする」という方法を試しました。\r\n\r\n```ps\r\n> npm ci\r\nnpm WARN prepare removing existing node_modules/ before installation\r\n...\r\nadded 1199 packages in 135.974s\r\n```\r\n\r\n作業開始時にnode_modulesは削除されると公式サイトに書いてありましたが、実行時にも警告が表示されました。\r\n\r\nvulnerabilitiesも着実に減少しました。\r\n\r\n```ps\r\ntar 適用時 = found 623 vulnerabilities (2 low, 7 moderate, 613 high, 1 critical) in 42979 scanned packages\r\nfstream 適用時 = found 622 vulnerabilities (2 low, 7 moderate, 612 high, 1 critical) in 42979 scanned packages\r\njs-yaml 適用時 = found 617 vulnerabilities (2 low, 4 moderate, 610 high, 1 critical) in 42979 scanned packages\r\nhandlebars 適用時 = found 616 vulnerabilities (2 low, 6 moderate, 608 high) in 42978 scanned packages\r\nlodash 適用時 = found 588 vulnerabilities (2 low, 7 moderate, 578 high, 1 critical) in 42979 scanned packages\r\nlodash.mergewith 適用時 = found 574 vulnerabilities (2 low, 3 moderate, 569 high) in 42978 scanned packages\r\nmixin-deep 適用時 = found 387 vulnerabilities (2 low, 3 moderate, 382 high) in 42978 scanned packages\r\n```\r\n\r\nまだまだ多くの更新が残っていますが、以前気軽に`npm update`したら意図せずangularのバージョンが上がって酷い目にあったので、残りはAngularのアップグレード後に確認しようと思います。。\r\n\r\n## 作業時に参照した情報\r\n\r\n- [Configuring automated security updates](https://help.github.com/ja/github/managing-security-vulnerabilities/configuring-automated-security-updates)\r\n- [npm-ci](https://docs.npmjs.com/cli/ci.html)\r\n"}