{"title":"node_modulesを更新する","date":"2020-02-09","category":"Nodejs","tag":["npm","Dependabot"],"body":"\r\n\r\nGithub で管理している Node.js アプリケーションで、依存 package のバージョンにセキュリティリスクがある場合に、Dependabot が警告してくれました。この警告を解消する手順を確認します。\r\n\r\n## 警告の内容を確認\r\n\r\ntech-log のリポジトリで、2020-02-09 時点で 9 件の Security Alerts がレポートされていました。\r\n\r\n<img src=\"\" alt=\"security alerts\" title=\"security alerts\">\r\n\r\nいずれも package.lock.json に対して変更行われており、間接的に依存している参照の更新が必要です。\r\n\r\n## npm audit を確認\r\n\r\nnpm にも監査のコマンドがあったことを思い出し、状況を確認してみました。\r\n\r\n```ps\r\n> npm audit\r\n...\r\nfound 625 vulnerabilities (2 low, 7 moderate, 615 high, 1 critical) in 42979 scanned packages\r\n  run `npm audit fix` to fix 624 of them.\r\n  1 vulnerability requires semver-major dependency updates.\r\n```\r\n\r\n625 件。。。今後の課題にしようと思います。\r\n\r\n## 個々の PR を npm ci して確認\r\n\r\n`npm ci`コマンドにより、pacakge.lock.json を元に node_modules を再構築してくれるようでした。なので「個々の PR に対してローカルリポジトリ上で`npm ci`し、app の挙動に問題がなければ master へ merge する」という方法を試しました。\r\n\r\n```ps\r\n> npm ci\r\nnpm WARN prepare removing existing node_modules/ before installation\r\n...\r\nadded 1199 packages in 135.974s\r\n```\r\n\r\n作業開始時に node_modules は削除されると公式サイトに書いてありましたが、実行時にも警告が表示されました。\r\n\r\nvulnerabilities も着実に減少しました。\r\n\r\n```ps\r\ntar 適用時 = found 623 vulnerabilities (2 low, 7 moderate, 613 high, 1 critical) in 42979 scanned packages\r\nfstream 適用時 = found 622 vulnerabilities (2 low, 7 moderate, 612 high, 1 critical) in 42979 scanned packages\r\njs-yaml 適用時 = found 617 vulnerabilities (2 low, 4 moderate, 610 high, 1 critical) in 42979 scanned packages\r\nhandlebars 適用時 = found 616 vulnerabilities (2 low, 6 moderate, 608 high) in 42978 scanned packages\r\nlodash 適用時 = found 588 vulnerabilities (2 low, 7 moderate, 578 high, 1 critical) in 42979 scanned packages\r\nlodash.mergewith 適用時 = found 574 vulnerabilities (2 low, 3 moderate, 569 high) in 42978 scanned packages\r\nmixin-deep 適用時 = found 387 vulnerabilities (2 low, 3 moderate, 382 high) in 42978 scanned packages\r\n```\r\n\r\n残りは Angular のアップグレード後に確認しようと思いました。\r\n\r\n## 関連項目\r\n\r\n- [Configuring automated security updates](https://help.github.com/ja/github/managing-security-vulnerabilities/configuring-automated-security-updates)\r\n- [npm-ci](https://docs.npmjs.com/cli/ci.html)\r\n"}